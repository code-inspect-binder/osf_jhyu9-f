title: this is mplus code to conduct multilevel rsa
       
       here we compute the average response surface 
       parameters including their standard errors 
       (automatically generated by mplus)

       variable names:
       grID = id for level 2 units
       pID = id for level 1 units
       x = the first predictor ('real age')
       y = the second predictor ('felt age')
       x2 = squared x
       xy = interaction x and y
       y2 = squared y
       xm - y2m are the level 2 means of x - y2
       g = the level 2 moderator ('spirituality')
       z = the outcome ('satisfaction')

       important:
       the data has to be prepared using the 
       PrepareData.r file prior to using the mplus
       codes; 

data: file is Fakedata_Mplus.dat; ! the data file
variable: ! the variables in the order they are saved 
          ! in the mplus file
          names are grID pID x y x2 xy y2
                    xm ym x2m xym y2m g z;
          ! say mplus which variables to use
          ! in the following analysis          
          usevariables are grID x y x2 xy
                    y2 xm ym x2m xym y2m z;
          ! mplus needs a variable defining the
          ! level 2 units (called cluster-variable)
          cluster = grID;
          ! say mplus which variables (except the outcome)
          ! is a level 1 variable
          within are x y x2 xy y2;
          ! say mplus which variable are pure level 2 
          ! variables
          between are xm ym x2m xym y2m;

analysis: ! use the standard estimator in mplus (ML-robust)
          type = twolevel random;
model: ! define the model to be estimated
    %within%
    ! regression of z on x, the slope is called b1
    ! the same for the other predictors
    b1 | z on x;  
    b2 | z on y;
    b3 | z on x2;
    b4 | z on xy;
    b5 | z on y2;
    %between%
    ! mplus automatically calls the intercept on level 2 as the 
    ! outcome variable predicted in the level 1 model; here z
    ! so the following line defines a regressions in which the means
    ! are used to predict the intercept (see Equation 11, first line)
    z on xm ym x2m xym y2m;
    [z]; ! estimate the mean of the intercept across level 2 units
    [b1] (gamma10); ! estimate the slope of x across level 2 units, call it gamma10
    [b2] (gamma20); ! estimate the slope of y across level 2 units, call it gamma20
    [b3] (gamma30); ! estimate the slope of x2 across level 2 units, call it gamma30
    [b4] (gamma40); ! estimate the slope of xy across level 2 units, call it gamma40
    [b5] (gamma50); ! estimate the slope of y2 across level 2 units, call it gamma50
    ! we estimate the full random effect structure by defining all correlations
    ! between the random effects
    z with b1 b2 b3 b4 b5;
    b1 with b2 b3 b4 b5;
    b2 with b3 b4 b5;
    b3 with b4 b5;
    b4 with b5;
    ! estimate the variances of the intercepts and the slopes
    z;
    b1-b5;
model constraint: 
   ! estimate the average response surface parameters
   ! say mplus that we want to compute five variables
   new(a1 a2 a3 a4 a5);
   ! define the five variables
   ! see Equation 11 in the article
   ! mplus automatically computes the standard errors
   ! (see Equation 13 in the article)
   a1 = gamma10+gamma20;
   a2 = gamma30+gamma40+gamma50;
   a3 = gamma10-gamma20;
   a4 = gamma30-gamma40+gamma50;
   a5 = gamma30-gamma50;
output: tech1, tech3, cinterval;
